# Техническое задание
Электронная очередь "Ветка" для ветеринарной клиники.

## Глоссарий
`ТА` - технический администратор;  
`АС` - администратор смены;  
`ВВ` - ветеринарный врач.  

## Общие требования
Система представляет собой `HTTP API` со следующими требованиями к бизнес-логике:
- регистрация, аутентификация и авторизация пользователей;
- учет и ведение списка пациентов (животных) клиники;
- учет и ведение списка записей на прием клиники;
- работа с очередью приемов.

## Абстрактная схема взаимодействия с системой
Ниже представлена абстрактная бизнес-логика взаимодействия с системой:

### Начало работы
1. После первого запуска в системе присутствует только один пользователь `ТА`.
2. `ТА` регистрирует пользователя `АС`.
3. `ТА` регистрирует двух пользователя `ВВ` (два врача на смене).

### Сценарий `АС`
#### Подготовка к работе
1. `АС` вводит логин и пароль для получения доступа к системе.

#### Предварительная запись на прием
1. Клиент обращается в клинику.
2. `АС` регистрирует данные владельца и пациента в списке пациентов, если они не были зарегистрированы ранее.
3. `АС` получает полный список приемов на указанный пользователем день.
4. `АС` регистрирует причину обращения и создает запись на прием к одному из врачей на смене в подходящий свободный временной слот c указанием предполагаемой длительности приема.

#### Работа с записанным клиентом в день приема
1. Клиент приходит к назначенному времени в клинику.
2. `АС` добавляет клиента в очередь, резервируя временной слот в соответствии с записью на прием.
3. Клиент идет на прием как только освободится врач.

#### Работа с не записанным клиентом в день приема
1. Клиент приходит в клинику.
2. `АС` регистрирует данные владельца и пациента в списке пациентов, если они не были зарегистрированы ранее.
3. `АС` получает полный список записей на прием на текущий день.
4. `АС` регистрирует причину обращения и создает запись на прием к одному из врачей на смене на ближайшее время c указанием предполагаемой длительности приема.
5. `АС` добавляет клиента в очередь, резервируя временной слот в соответствии с записью на прием.

##### Отсутствие других записей на это время
Клиент идет на прием как только освободится врач.

##### Существует другая запись на прием на это время
1. Если ранее записанный клиент не приходит в указанное время, его прием отменяется и следующий клиент в очереди идет на прием.
2. Если ранее записанный клиент приходит в указанное время, `AC` добавляет его в очередь с наибольшим приоритетом и отправляет на прием. Остальные клиенты ждут своей очереди.

#### Отмена приема
1. Клиент не приходит на прием или обращается лично.
2. `АС` помечает прием как отмененный.

### Сценарий `ВВ`
#### Подготовка к работе
1. `ВВ` вводит логин и пароль для получения доступа к системе.
2. Просмотр записей на прием: получение списка своих приемов на сегодня без учета отмененных.

#### Ведение приема
1. Просмотр очереди приемов.
2. Изменение статуса приема на "открыт" после попадания пациента в ветеринарный кабинет.
3. Изменение статуса приема на "закрыт" после ухода пациента из ветеринарного кабинета.
4. `ВВ ` удаляет клиента из очереди.

#### Планирование работы
1. Просмотр общей очереди: получение полного списка всех приемов на сегодня и другие дни без учета отмененых.
2. Получение полного списка пациентов (свои и других врачей).
3. Получение полного списка приемов пацента, включая отмененные.

## Список разрешенных операций
(!) Указаны только разрешенные операции.

## `ТА`
Доступны все операции с системой.

## `АС`
Доступны все операции со списков пациентов, приемов и очередью.

## `ВВ`
Доступны все операции со списков пациентов, приемов и очередью.

### Сводное HTTP API
Электронная очередь "Ветка" должна предоставлять следующие `HTTP`-хендлеры:
- `POST /api/v1/login` - аутентификация пользователя;
- `GET /api/v1/roles` - получение списка ролей;
- `GET /api/v1/users` - получение списка пользователей;
- `POST /api/v1/users` - регистрация пользователя;

- `GET /api/v1/patients` - получение списка пациентов;
- `POST /api/v1/patients` - регистрация нового пациента;

- `POST /api/v1/appointments` - создание новой записи на прием;
- `GET /api/v1/appointments` - получение списка записей c фильтрацией по пациенту;
- `PATCH /api/v1/appointments/id:uuid` - открытие, закрытие, отмена записи на прием;

- `GET /api/v1/queue` - получения списка приемов в очереди;
- `POST /api/v1/queue` - добавить прием в очередь;
- `POST /api/v1/queue/id:int/up` - поднять прием в очереди;
- `POST /api/v1/queue/id:int/down` - понизить прием в очереди;
- `DELETE /api/v1/queue/id:int` - удалить прием из очереди.

## Общие ограничения и требования
- хранилище данных - `PostgreSQL`;
- информация об очереди хранится в сервисе `Redis`;
- регистрация производится по паре логин/пароль, каждый логин должен быть уникальным.
- для передачи аутентификационных данных используется `HTTP`-заголовок `Authorization` и `JWT`-токен;
- открытый прием нельзя отменить или удалить;
- пользователи могут изменять положение клиентов в очереди;
- пациента нельзя удалить, если его прием открыт;
- одновременно один врач может иметь только один открытый прием;
- идентификаторы пациентов, пользователей и приемов уникальны;
- структура таблиц остаётся на усмотрение студента;
- типы и формат хранения данных (в том числе паролей и прочей чувствительной информации) остаётся на усмотрение студента;
- клиент может поддерживать HTTP-запросы/ответы со сжатием данных;
- клиент не обязан делать запросы соответственно нижеизложенной спецификации API, любая проверка запроса остаётся на усмотрение студента;
- формат и алгоритм проверки аутентификации и авторизации пользователя остаётся на усмотрение студента.

## Конфигурирование сервиса
Сервис должен поддерживать конфигурирование следующими методами:
- адрес и порт запуска сервиса: переменная окружения ОС `RUN_ADDRESS` или флаг `a`;
- адрес подключения к базе данных `Postgres`: переменная окружения ОС `DATABASE_URI` или флаг `d`;
- адрес подключения к `Redis`: переменная окружения ОС `REDIS_URI` или флаг `r`;
- секретный ключ для генерации подписи: переменная окружения ОС `SECRET` или флаг `s`;
- уровень логирования: переменная окружения ОС `LOG_LEVEL` или флаг `l`.
